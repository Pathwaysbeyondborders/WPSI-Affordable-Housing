<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>West Philadelphia Skilled Initiative - Affordable Housing Budgeting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .app-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      background: #111827;
      border-radius: 24px;
      padding: 24px;
      max-width: 1300px;
      width: 100%;
      box-shadow: 0 20px 50px rgba(0,0,0,0.4);
    }

    @media (max-width: 960px) {
      .app-container {
        grid-template-columns: 1fr;
      }
    }

    .left-panel {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .header-title {
      font-size: 1.6rem;
      font-weight: 700;
      color: #38bdf8;
    }

    .header-subtitle {
      font-size: 0.95rem;
      color: #9ca3af;
      max-width: 720px;
    }

    .card {
      background: #020817;
      border-radius: 18px;
      padding: 16px 18px;
      border: 1px solid rgba(148,163,253,0.15);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #bfdbfe;
      margin-bottom: 4px;
    }

    .card-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    label {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    select,
    input[type="number"],
    input[type="text"] {
      background: #020817;
      border-radius: 10px;
      border: 1px solid #374151;
      padding: 8px 10px;
      color: #e5e7eb;
      font-size: 0.85rem;
      outline: none;
    }

    select {
      min-width: 140px;
    }

    select:focus,
    input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.2);
    }

    .housing-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }

    .housing-card {
      background: #020817;
      border-radius: 12px;
      padding: 10px;
      border: 1px solid #1f2937;
      cursor: pointer;
      transition: all 0.18s ease;
      font-size: 0.8rem;
    }

    .housing-card span {
      display: block;
    }

    .housing-card strong {
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .housing-card.selected {
      border-color: #38bdf8;
      box-shadow: 0 0 15px rgba(56,189,248,0.25);
      transform: translateY(-2px);
    }

    .results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-top: 4px;
    }

    .result-box {
      background: #020817;
      border-radius: 12px;
      padding: 10px;
      border: 1px solid #111827;
      font-size: 0.8rem;
    }

    .result-label {
      color: #6b7280;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .result-value {
      font-size: 1rem;
      font-weight: 600;
      margin-top: 4px;
      color: #e5e7eb;
      word-break: break-word;
    }

    .result-note {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 4px;
    }

    .result-value.negative {
      color: #f97373;
    }

    /* Expense layout */

    .expense-groups {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .expense-group-title {
      font-size: 0.78rem;
      font-weight: 600;
      color: #93c5fd;
      margin-bottom: 4px;
    }

    .expense-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 5px;
      flex-wrap: wrap;
    }

    .expense-row label {
      font-size: 0.75rem;
      color: #9ca3af;
      min-width: 90px;
      max-width: 130px;
    }

    .expense-row input[type="number"] {
      width: 80px;
      flex: 0 0 80px;
      text-align: right;
    }

    .expense-row input[type="text"] {
      width: 130px;
      flex: 0 0 130px;
    }

    .swipe-btn {
      padding: 6px 8px;
      font-size: 0.7rem;
      border-radius: 999px;
      border: 1px solid #38bdf8;
      background: transparent;
      color: #38bdf8;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.18s ease;
      flex: 0 0 auto;
    }

    .swipe-btn:hover {
      background: #38bdf8;
      color: #020817;
    }

    .download-btn {
      margin-top: 8px;
      padding: 8px 14px;
      font-size: 0.8rem;
      border-radius: 999px;
      border: none;
      background: #38bdf8;
      color: #020817;
      cursor: pointer;
      font-weight: 600;
      align-self: flex-start;
      transition: all 0.18s ease;
    }

    .download-btn:hover {
      background: #0ea5e9;
      transform: translateY(-1px);
    }

    /* Right side debit card */

    .right-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .debit-card {
      position: relative;
      background: radial-gradient(circle at top left, #38bdf8 0%, #111827 40%, #4f46e5 100%);
      border-radius: 22px;
      padding: 18px 18px 14px;
      color: #e5e7eb;
      box-shadow: 0 16px 40px rgba(15,23,42,0.9);
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 190px;
    }

    .debit-chip {
      width: 32px;
      height: 24px;
      border-radius: 6px;
      border: 2px solid rgba(229,231,235,0.9);
      margin-bottom: 4px;
    }

    .debit-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      opacity: 0.85;
    }

    .debit-title {
      font-size: 1.2rem;
      font-weight: 700;
    }

    .debit-balance-label {
      font-size: 0.7rem;
      opacity: 0.9;
      margin-top: 4px;
    }

    .debit-balance {
      font-size: 1.4rem;
      font-weight: 700;
      transition: color 0.18s ease;
      word-break: break-word;
    }

    .debit-balance.negative {
      color: #f97373;
    }

    .debit-name {
      margin-top: auto;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .debit-tagline {
      font-size: 0.65rem;
      opacity: 0.9;
    }

    .card-summary {
      margin-top: 10px;
      font-size: 0.72rem;
      color: #d1d5db;
      line-height: 1.4;
    }

    .card-summary-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .card-summary-list {
      list-style: none;
      padding-left: 0;
      max-height: 140px;
      overflow-y: auto;
    }

    .card-summary-list li {
      margin-bottom: 2px;
    }

    .side-note {
      font-size: 0.72rem;
      color: #9ca3af;
      line-height: 1.4;
    }
  </style>
</head>
<body>
<div class="app-container">
  <!-- LEFT: Controls & Results -->
  <div class="left-panel">
    <div>
      <div class="header-title">West Philadelphia Skilled Initiative<br>Affordable Housing Budgeting</div>
      <p class="header-subtitle">
        Select your WPSI job, hours, housing, savings, and expenses. Each “Swipe / Update” simulates
        a real-life purchase and updates your WPSI Debit balance instantly.
      </p>
    </div>

    <!-- Name & Job -->
    <div class="card">
      <div class="section-title">1. Participant Details & Income</div>
      <div class="row">
        <div>
          <label for="firstName">First Name</label><br />
          <input type="text" id="firstName" placeholder="First name" />
        </div>
        <div>
          <label for="lastName">Last Name</label><br />
          <input type="text" id="lastName" placeholder="Last name" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="jobSelect">Job Role</label><br />
          <select id="jobSelect">
            <option value="21">ASA - $21.00/hr</option>
            <option value="19">UPenn Prez - $19.00/hr</option>
            <option value="19">CHOP CA - $19.00/hr</option>
            <option value="20">CHOP CLA - $20.00/hr</option>
            <option value="26">AESPETIC TECH - $26.00/hr</option>
          </select>
        </div>
        <div>
          <label for="hoursPerWeek">Hours per week</label><br />
          <input type="number" id="hoursPerWeek" value="40" min="5" max="60" />
        </div>
      </div>
      <p class="side-note">
        This tool uses a combined estimate for federal, Pennsylvania, Philadelphia, and payroll taxes
        for educational purposes (not official tax advice).
      </p>
    </div>

    <!-- Housing -->
    <div class="card">
      <div class="section-title">2. Choose an Apartment Option</div>
      <div class="card-label">Studio, One Bedroom & Two Bedroom options from $1,100 to $1,700</div>
      <div class="housing-options" id="housingOptions"></div>
    </div>

    <!-- Savings -->
    <div class="card">
      <div class="section-title">3. Pay Yourself First: Savings</div>
      <div class="row">
        <div>
          <label for="savingsRate">Savings Goal (% of take-home pay)</label><br />
          <input type="number" id="savingsRate" value="10" min="0" max="50" />
        </div>
      </div>
      <p class="side-note">
        Aim for at least <strong>10%</strong> of your net income for savings or an emergency fund.
      </p>
    </div>

    <!-- Expenses -->
    <div class="card">
      <div class="section-title">4. Monthly Living Expenses</div>
      <p class="card-label">
        Enter an amount and (if custom) a charge name, then click <strong>Swipe / Update</strong>.
        Set to 0 and Swipe to remove the expense.
      </p>
      <div class="expense-groups">

        <!-- Utilities -->
        <div>
          <div class="expense-group-title">Utilities</div>
          <div class="expense-row">
            <label>Electricity</label>
            <input type="number" id="exp-electricity" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('electricity','exp-electricity','Electricity')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <label>Gas</label>
            <input type="number" id="exp-gas" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('gas','exp-gas','Gas')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <label>Water/Sewer</label>
            <input type="number" id="exp-water" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('water','exp-water','Water/Sewer')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <label>Internet</label>
            <input type="number" id="exp-internet" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('internet','exp-internet','Internet')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <label>Cellphone</label>
            <input type="number" id="exp-cell" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('cell','exp-cell','Cellphone')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <input type="text" id="exp-util-custom-label" placeholder="Custom utility" />
            <input type="number" id="exp-util-custom" min="0" placeholder="0" />
            <button class="swipe-btn"
              onclick="swipeCustom('util-custom','exp-util-custom','exp-util-custom-label')">Swipe / Update</button>
          </div>
        </div>

        <!-- Food -->
        <div>
          <div class="expense-group-title">Food</div>
          <div class="expense-row">
            <label>Groceries</label>
            <input type="number" id="exp-groceries" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('groceries','exp-groceries','Groceries')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <label>Dining Out</label>
            <input type="number" id="exp-dining" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('dining','exp-dining','Dining Out')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <input type="text" id="exp-food-custom-label" placeholder="Custom food" />
            <input type="number" id="exp-food-custom" min="0" placeholder="0" />
            <button class="swipe-btn"
              onclick="swipeCustom('food-custom','exp-food-custom','exp-food-custom-label')">Swipe / Update</button>
          </div>
        </div>

        <!-- Childcare -->
        <div>
          <div class="expense-group-title">Childcare</div>
          <div class="expense-row">
            <label>Daycare</label>
            <input type="number" id="exp-daycare" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('daycare','exp-daycare','Daycare')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <label>After-School</label>
            <input type="number" id="exp-afterschool" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('afterschool','exp-afterschool','After-School')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <input type="text" id="exp-child-custom-label" placeholder="Custom childcare" />
            <input type="number" id="exp-child-custom" min="0" placeholder="0" />
            <button class="swipe-btn"
              onclick="swipeCustom('child-custom','exp-child-custom','exp-child-custom-label')">Swipe / Update</button>
          </div>
        </div>

        <!-- Transportation -->
        <div>
          <div class="expense-group-title">Transportation</div>
          <div class="expense-row">
            <label>Car Loan</label>
            <input type="number" id="exp-carloan" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('carloan','exp-carloan','Car Loan')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <label>Auto Ins.</label>
            <input type="number" id="exp-autoins" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('autoins','exp-autoins','Auto Insurance')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <label>Fuel</label>
            <input type="number" id="exp-fuel" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('fuel','exp-fuel','Fuel')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <label>Maint.</label>
            <input type="number" id="exp-maint" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('maint','exp-maint','Maintenance')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <label>Transit</label>
            <input type="number" id="exp-transit" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('transit','exp-transit','Transit Pass')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <input type="text" id="exp-trans-custom-label" placeholder="Custom transport" />
            <input type="number" id="exp-trans-custom" min="0" placeholder="0" />
            <button class="swipe-btn"
              onclick="swipeCustom('trans-custom','exp-trans-custom','exp-trans-custom-label')">Swipe / Update</button>
          </div>
        </div>

        <!-- Pets -->
        <div>
          <div class="expense-group-title">Pets</div>
          <div class="expense-row">
            <label>Food/Suppl.</label>
            <input type="number" id="exp-petfood" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('petfood','exp-petfood','Pet Food & Supplies')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <label>Vet Fund</label>
            <input type="number" id="exp-vetfund" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('vetfund','exp-vetfund','Vet Care Fund')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <label>Pet Ins.</label>
            <input type="number" id="exp-petins" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('petins','exp-petins','Pet Insurance')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <label>Groom/Board</label>
            <input type="number" id="exp-groom" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('groom','exp-groom','Grooming/Boarding')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <input type="text" id="exp-pet-custom-label" placeholder="Custom pet" />
            <input type="number" id="exp-pet-custom" min="0" placeholder="0" />
            <button class="swipe-btn"
              onclick="swipeCustom('pet-custom','exp-pet-custom','exp-pet-custom-label')">Swipe / Update</button>
          </div>
        </div>

        <!-- Other / Lifestyle -->
        <div>
          <div class="expense-group-title">Other / Lifestyle</div>
          <div class="expense-row">
            <label>Streaming</label>
            <input type="number" id="exp-stream" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('stream','exp-stream','Streaming/Entertainment')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <label>Gym</label>
            <input type="number" id="exp-gym" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('gym','exp-gym','Gym Membership')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <label>Clothing</label>
            <input type="number" id="exp-clothing" min="0" placeholder="0" />
            <button class="swipe-btn" onclick="swipeExpense('clothing','exp-clothing','Clothing/Personal Care')">Swipe / Update</button>
          </div>
          <div class="expense-row">
            <input type="text" id="exp-life-custom-label" placeholder="Custom lifestyle" />
            <input type="number" id="exp-life-custom" min="0" placeholder="0" />
            <button class="swipe-btn"
              onclick="swipeCustom('life-custom','exp-life-custom','exp-life-custom-label')">Swipe / Update</button>
          </div>
        </div>

      </div>
    </div>

    <!-- Results & Download -->
    <div class="card">
      <div class="section-title">5. Budget Snapshot</div>
      <div class="results">
        <div class="result-box">
          <div class="result-label">Gross Monthly Income</div>
          <div class="result-value" id="grossMonthly">$0.00</div>
        </div>
        <div class="result-box">
          <div class="result-label">Est. Monthly Taxes</div>
          <div class="result-value" id="taxesMonthly">$0.00</div>
        </div>
        <div class="result-box">
          <div class="result-label">Estimated Take-Home Pay</div>
          <div class="result-value" id="netMonthly">$0.00</div>
        </div>
        <div class="result-box">
          <div class="result-label">Selected Rent</div>
          <div class="result-value" id="rentAmount">$0.00</div>
          <div class="result-note" id="rentTypeLabel">No apartment selected.</div>
        </div>
        <div class="result-box">
          <div class="result-label">Monthly Savings</div>
          <div class="result-value" id="savingsMonthly">$0.00</div>
        </div>
        <div class="result-box">
          <div class="result-label">Expenses (Excl. Rent & Savings)</div>
          <div class="result-value" id="totalExpenses">$0.00</div>
        </div>
        <div class="result-box">
          <div class="result-label">Left After All</div>
          <div class="result-value" id="leftover">$0.00</div>
          <div class="result-note" id="safetyNote"></div>
        </div>
      </div>
      <button class="download-btn" onclick="downloadBudgetCSV()">
        Download Budget Snapshot &amp; Expenses (CSV)
      </button>
    </div>
  </div>

  <!-- RIGHT: WPSI Debit Card & Summary -->
  <div class="right-panel">
    <div class="debit-card">
      <div class="debit-chip"></div>
      <div class="debit-label">West Philadelphia Skilled Initiative</div>
      <div class="debit-title">WPSI Debit</div>
      <div class="debit-balance-label">Available after rent, savings &amp; expenses</div>
      <div class="debit-balance" id="cardBalance">$0.00</div>
      <div class="debit-name" id="cardName">Participant Name</div>
      <div class="debit-tagline">Practice real-world money moves with smart housing choices.</div>
    </div>

    <div class="card">
      <div class="card-summary">
        <div class="card-summary-title">Apartment Choice</div>
        <div id="cardApartment">No apartment selected.</div>
      </div>
      <div class="card-summary">
        <div class="card-summary-title">Monthly Expenses Swiped</div>
        <ul id="cardExpensesList" class="card-summary-list">
          <li>No expenses added yet.</li>
        </ul>
      </div>
      <p class="side-note">
        As participants swipe expenses, this summary shows where their money goes each month—
        reinforcing conscious spending decisions.
      </p>
    </div>
  </div>
</div>

<script>
  const HOUSING_OPTIONS = [
    { id: 1, type: "Studio", rent: 1100 },
    { id: 2, type: "Studio", rent: 1300 },
    { id: 3, type: "1 Bedroom", rent: 1300 },
    { id: 4, type: "1 Bedroom", rent: 1500 },
    { id: 5, type: "2 Bedroom", rent: 1500 },
    { id: 6, type: "2 Bedroom", rent: 1700 }
  ];

  const TAX_RATES = {
    federal: 0.05,
    pa: 0.0307,
    local: 0.038,
    fica: 0.0765
  };
  const TOTAL_TAX_RATE =
    TAX_RATES.federal +
    TAX_RATES.pa +
    TAX_RATES.local +
    TAX_RATES.fica;

  const housingContainer = document.getElementById("housingOptions");
  const jobSelect = document.getElementById("jobSelect");
  const hoursPerWeekInput = document.getElementById("hoursPerWeek");
  const savingsRateInput = document.getElementById("savingsRate");
  const firstNameInput = document.getElementById("firstName");
  const lastNameInput = document.getElementById("lastName");

  const grossMonthlyEl = document.getElementById("grossMonthly");
  const taxesMonthlyEl = document.getElementById("taxesMonthly");
  const netMonthlyEl = document.getElementById("netMonthly");
  const rentAmountEl = document.getElementById("rentAmount");
  const rentTypeLabelEl = document.getElementById("rentTypeLabel");
  const savingsMonthlyEl = document.getElementById("savingsMonthly");
  const totalExpensesEl = document.getElementById("totalExpenses");
  const leftoverEl = document.getElementById("leftover");
  const safetyNoteEl = document.getElementById("safetyNote");
  const cardBalanceEl = document.getElementById("cardBalance");
  const cardNameEl = document.getElementById("cardName");
  const cardApartmentEl = document.getElementById("cardApartment");
  const cardExpensesListEl = document.getElementById("cardExpensesList");

  let selectedHousing = null;
  let expenses = {};

  function renderHousingOptions() {
    housingContainer.innerHTML = "";
    HOUSING_OPTIONS.forEach(option => {
      const div = document.createElement("div");
      div.className = "housing-card";
      div.dataset.id = option.id;
      div.innerHTML = `
        <span><strong>${option.type}</strong></span>
        <span>Rent: $${option.rent.toLocaleString()}/month</span>
      `;
      div.addEventListener("click", () => {
        document.querySelectorAll(".housing-card").forEach(c => c.classList.remove("selected"));
        div.classList.add("selected");
        selectedHousing = option;
        updateAll();
      });
      housingContainer.appendChild(div);
    });
  }

  function calculateGrossMonthly(hourly, hoursPerWeek) {
    return hourly * hoursPerWeek * 4.33;
  }

  function calculateTaxes(gross) {
    return gross * TOTAL_TAX_RATE;
  }

  function swipeExpense(key, amountInputId, defaultLabel) {
    const amountInput = document.getElementById(amountInputId);
    if (!amountInput) return;
    const raw = parseFloat(amountInput.value);
    const amount = isNaN(raw) ? 0 : raw;

    if (amount <= 0) {
      delete expenses[key];
      amountInput.value = "";
    } else {
      expenses[key] = { label: defaultLabel, amount };
    }
    updateAll();
  }

  function swipeCustom(key, amountInputId, labelInputId) {
    const amountInput = document.getElementById(amountInputId);
    const labelInput = document.getElementById(labelInputId);
    if (!amountInput || !labelInput) return;

    const raw = parseFloat(amountInput.value);
    const amount = isNaN(raw) ? 0 : raw;
    const label = labelInput.value.trim() || "Custom Charge";

    if (amount <= 0) {
      delete expenses[key];
      amountInput.value = "";
    } else {
      expenses[key] = { label, amount };
    }
    updateAll();
  }

  function getTotalExpenses() {
    return Object.values(expenses).reduce((sum, exp) => sum + (exp.amount || 0), 0);
  }

  function updateCardName() {
    const first = firstNameInput.value.trim();
    const last = lastNameInput.value.trim();
    const full = (first + " " + last).trim();
    cardNameEl.textContent = full || "Participant Name";
  }

  function updateCardApartment() {
    if (selectedHousing) {
      cardApartmentEl.textContent =
        `${selectedHousing.type} • $${selectedHousing.rent.toFixed(2)}/month`;
    } else {
      cardApartmentEl.textContent = "No apartment selected.";
    }
  }

  function updateCardExpensesList() {
    cardExpensesListEl.innerHTML = "";
    const keys = Object.keys(expenses);
    if (!keys.length) {
      cardExpensesListEl.innerHTML = "<li>No expenses added yet.</li>";
      return;
    }
    keys.forEach(key => {
      const exp = expenses[key];
      const li = document.createElement("li");
      li.textContent = `${exp.label}: $${exp.amount.toFixed(2)}`;
      cardExpensesListEl.appendChild(li);
    });
  }

  function updateAll() {
    const hourly = parseFloat(jobSelect.value) || 0;
    const hoursPerWeek = parseFloat(hoursPerWeekInput.value) || 0;
    const savingsRate = Math.max(parseFloat(savingsRateInput.value) || 0, 0);

    const gross = calculateGrossMonthly(hourly, hoursPerWeek);
    const taxes = calculateTaxes(gross);
    const net = Math.max(gross - taxes, 0);

    grossMonthlyEl.textContent = "$" + gross.toFixed(2);
    taxesMonthlyEl.textContent = "$" + taxes.toFixed(2);
    netMonthlyEl.textContent = "$" + net.toFixed(2);

    let rent = 0;
    if (selectedHousing) {
      rent = selectedHousing.rent;
      rentAmountEl.textContent = "$" + rent.toFixed(2);
      rentTypeLabelEl.textContent = `${selectedHousing.type} selected`;
    } else {
      rentAmountEl.textContent = "$0.00";
      rentTypeLabelEl.textContent = "No apartment selected.";
    }

    const savings = net * (savingsRate / 100);
    savingsMonthlyEl.textContent = "$" + savings.toFixed(2);

    const totalExpenses = getTotalExpenses();
    totalExpensesEl.textContent = "$" + totalExpenses.toFixed(2);

    const afterRent = net - rent;
    const afterSavings = afterRent - savings;
    const leftover = afterSavings - totalExpenses;

    leftoverEl.textContent = "$" + leftover.toFixed(2);
    cardBalanceEl.textContent = "$" + leftover.toFixed(2);

    if (leftover < 0) {
      leftoverEl.classList.add("negative");
      cardBalanceEl.classList.add("negative");
      safetyNoteEl.textContent =
        "Warning: Your account is negative. Adjust housing, savings, or expenses to get back in balance.";
    } else {
      leftoverEl.classList.remove("negative");
      cardBalanceEl.classList.remove("negative");

      if (!selectedHousing) {
        safetyNoteEl.textContent = "Choose an apartment to see how housing impacts your balance.";
      } else if (gross > 0 && rent / gross <= 0.3) {
        safetyNoteEl.textContent = "Strong choice: Rent is about 30% or less of your gross income.";
      } else if (gross > 0 && rent / gross <= 0.4) {
        safetyNoteEl.textContent = "Caution: Rent is a high share of income. Budget carefully.";
      } else if (gross > 0 && rent > 0) {
        safetyNoteEl.textContent = "Warning: Rent is very high compared to income. This may be hard to sustain.";
      } else {
        safetyNoteEl.textContent = "";
      }
    }

    updateCardName();
    updateCardApartment();
    updateCardExpensesList();
  }

  function downloadBudgetCSV() {
    const first = firstNameInput.value.trim();
    const last = lastNameInput.value.trim();
    const name = (first + " " + last).trim() || "Participant";

    const gross = grossMonthlyEl.textContent.replace("$", "");
    const taxes = taxesMonthlyEl.textContent.replace("$", "");
    const net = netMonthlyEl.textContent.replace("$", "");
    const rent = rentAmountEl.textContent.replace("$", "");
    const savings = savingsMonthlyEl.textContent.replace("$", "");
    const totalExp = totalExpensesEl.textContent.replace("$", "");
    const leftover = leftoverEl.textContent.replace("$", "");

    let csv = "Category,Label,Amount\n";
    csv += `Summary,Participant Name,${name}\n`;
    csv += `Summary,Gross Monthly Income,${gross}\n`;
    csv += `Summary,Estimated Taxes,${taxes}\n`;
    csv += `Summary,Net Take-Home Pay,${net}\n`;
    csv += `Summary,Rent,${rent}\n`;
    csv += `Summary,Monthly Savings,${savings}\n`;
    csv += `Summary,Other Expenses (Excl. Rent & Savings),${totalExp}\n`;
    csv += `Summary,Left After All,${leftover}\n`;

    if (selectedHousing) {
      csv += `Housing,Apartment Type,${selectedHousing.type}\n`;
      csv += `Housing,Apartment Rent,${selectedHousing.rent}\n`;
    }

    Object.values(expenses).forEach(exp => {
      csv += `Expense,${exp.label},${exp.amount}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    const safeName = name.replace(/\s+/g, "_");
    link.href = url;
    link.setAttribute("download", `${safeName || "budget"}_WPSI_budget.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  jobSelect.addEventListener("change", updateAll);
  hoursPerWeekInput.addEventListener("input", updateAll);
  savingsRateInput.addEventListener("input", updateAll);
  firstNameInput.addEventListener("input", updateAll);
  lastNameInput.addEventListener("input", updateAll);

  renderHousingOptions();
  updateAll();
</script>
</body>
</html>
